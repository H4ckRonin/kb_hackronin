---
import { getCollection, render } from 'astro:content';
import readingTime from 'reading-time';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Icon from '../../components/Icons.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import FurtherReading from '../../components/FurtherReading.astro';
import Giscus from '../../components/Giscus.astro';
import { enrichCertData, generateTitleFromFilename } from '../../utils/content';
import { withBase } from '../../utils/paths';

// Helper to get base URL at build time
const baseUrl = import.meta.env.BASE_URL || '/';

export async function getStaticPaths() {
	const certs = await getCollection('certifications');
	const enrichedCerts = certs.map(cert => enrichCertData(cert));
	
	// Filter out files that don't have at least 2 parts (category/filename minimum)
	// and sort by category, vendor, certification, then title
	const validCerts = enrichedCerts.filter(cert => {
		const parts = cert.id.split('/').filter(p => p);
		return parts.length >= 2; // At least category/filename
	});
	
	validCerts.sort((a, b) => {
		const aCat = a.data.category || '';
		const bCat = b.data.category || '';
		if (aCat !== bCat) return aCat.localeCompare(bCat);
		
		const aVendor = a.data.vendor || '';
		const bVendor = b.data.vendor || '';
		if (aVendor !== bVendor) return aVendor.localeCompare(bVendor);
		
		const aCert = a.data.certification || '';
		const bCert = b.data.certification || '';
		if (aCert !== bCert) return aCert.localeCompare(bCert);
		
		const aTitle = a.data.title || a.id;
		const bTitle = b.data.title || b.id;
		return aTitle.localeCompare(bTitle);
	});
	
	return validCerts.map((cert, index) => {
		const slugPath = cert.id.replace(/\.md$/, '');
		
		// Find items in the same group (same category/vendor/certification)
		// For 3-part paths (no certification), group by category/vendor
		const sameGroup = validCerts.filter(c => {
			if (cert.data.certification && c.data.certification) {
				// Both have certification level
				return c.data.category === cert.data.category &&
				       c.data.vendor === cert.data.vendor &&
				       c.data.certification === cert.data.certification;
			} else if (!cert.data.certification && !c.data.certification) {
				// Both are 3-part paths (no certification)
				return c.data.category === cert.data.category &&
				       c.data.vendor === cert.data.vendor;
			}
			return false;
		});
		
		const currentIndexInGroup = sameGroup.findIndex(c => c.id === cert.id);
		const previous = currentIndexInGroup > 0 ? sameGroup[currentIndexInGroup - 1] : null;
		const next = currentIndexInGroup < sameGroup.length - 1 ? sameGroup[currentIndexInGroup + 1] : null;
		
		// Get related items (same certification group, or same category)
		const related = validCerts.filter(c => {
			if (c.id === cert.id) return false;
			if (cert.data.certification && c.data.certification) {
				return c.data.certification === cert.data.certification && 
				       c.data.vendor === cert.data.vendor;
			}
			return c.data.category === cert.data.category;
		}).slice(0, 3);
		
		return {
			params: { slug: slugPath },
			props: { 
				cert, 
				originalId: cert.id,
				previous: previous ? {
					title: previous.data.title || generateTitleFromFilename(previous.id.split('/').pop()?.replace('.md', '') || ''),
					href: withBase(`/certifications/${previous.id.replace(/\.md$/, '')}`)
				} : null,
				next: next ? {
					title: next.data.title || generateTitleFromFilename(next.id.split('/').pop()?.replace('.md', '') || ''),
					href: withBase(`/certifications/${next.id.replace(/\.md$/, '')}`)
				} : null,
				related: related.map(r => ({
					title: r.data.title || generateTitleFromFilename(r.id.split('/').pop()?.replace('.md', '') || ''),
					href: withBase(`/certifications/${r.id.replace(/\.md$/, '')}`),
					description: r.data.description || ''
				}))
			},
		};
	});
}

const { cert, originalId, previous, next, related } = Astro.props;
const { title, category, vendor, certification, description } = cert.data;
const readingTimeEstimate = readingTime(cert.body);
const wordCount = cert.body.split(/\s+/).length;
const permalink = `${Astro.site.href}certifications/${originalId.replace(/\.md$/, '')}`;
const { Content } = await render(cert);

// Generate page title - use enriched title or generate from filename
const pageTitle = title || generateTitleFromFilename(originalId.split('/').pop()?.replace('.md', '') || originalId) || 'Untitled';

// Build breadcrumbs
const breadcrumbs = [];
if (category) breadcrumbs.push({ name: category.replace(/-/g, ' '), href: withBase(`/certifications?category=${category}`) });
if (vendor) breadcrumbs.push({ name: vendor.replace(/-/g, ' '), href: withBase(`/certifications?vendor=${vendor}`) });
if (certification) breadcrumbs.push({ name: certification.replace(/\d+-/g, '').replace(/-/g, ' '), href: withBase(`/certifications?certification=${certification}`) });
---

<BaseLayout title={pageTitle} description={description || ''} permalink={permalink} current="certifications">
  <script is:inline>
    document.body.setAttribute('data-page', 'certifications');
  </script>
  
  <div class="cert-page-wrapper">
    {breadcrumbs.length > 0 && (
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href={withBase('/certifications')}>Certifications</a>
        {breadcrumbs.map((crumb, i) => (
          <>
            <span class="breadcrumb-separator">/</span>
            {i === breadcrumbs.length - 1 ? (
              <span class="breadcrumb-current">{crumb.name}</span>
            ) : (
              <a href={crumb.href}>{crumb.name}</a>
            )}
          </>
        ))}
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">{pageTitle}</span>
      </nav>
    )}
    
    <div class="cert-meta">
      <div class="cert-stats">
        <span>{readingTimeEstimate.text}</span>
        <span>â€¢</span>
        <span>{wordCount} words</span>
      </div>
      {(category || vendor || certification) && (
        <div class="cert-taxonomy">
          {category && (
            <a href={withBase(`/certifications?category=${category}`)} class="category-tag">
              {category.replace(/-/g, ' ')}
            </a>
          )}
          {vendor && (
            <a href={withBase(`/certifications?vendor=${vendor}`)} class="vendor-tag">
              {vendor.replace(/-/g, ' ')}
            </a>
          )}
          {certification && (
            <a href={withBase(`/certifications?certification=${certification}`)} class="cert-tag">
              {certification.replace(/\d+-/g, '').replace(/-/g, ' ')}
            </a>
          )}
        </div>
      )}
    </div>
    
    <div class="cert-content-wrapper">
    <article class="cert-content">
      <Content />
    </article>
    
      <TableOfContents />
    </div>
    
    <PostNavigation previous={previous} next={next} collectionType="certifications" />
    
    <Giscus
      repo={import.meta.env.PUBLIC_GISCUS_REPO || "h4ckronin/kb_hackronin"}
      repoId={import.meta.env.PUBLIC_GISCUS_REPO_ID || ""}
      category={import.meta.env.PUBLIC_GISCUS_CATEGORY || "General"}
      categoryId={import.meta.env.PUBLIC_GISCUS_CATEGORY_ID || ""}
      mapping="pathname"
      theme="preferred_color_scheme"
      lang="en"
      reactionsEnabled={true}
      emitMetadata={false}
      inputPosition="bottom"
      loading="lazy"
    />
    
    {related.length > 0 && (
      <FurtherReading relatedItems={related} collectionType="certifications" />
    )}
  </div>
</BaseLayout>

<style>
  .cert-page-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    padding-top: 1rem; /* Less top padding since breadcrumbs have their own */
    position: relative;
    z-index: 20;
    width: 100%;
    box-sizing: border-box;
  }

  @media (max-width: 768px) {
    .cert-page-wrapper {
      padding-top: 0.5rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }

  @media (max-width: 480px) {
    .cert-page-wrapper {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
  }

  .cert-content-wrapper {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 3rem;
    align-items: start;
  }

  @media (max-width: 1200px) {
    .cert-content-wrapper {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }

  @media (max-width: 768px) {
    .cert-page-wrapper {
      padding: 1rem;
    }

    .cert-content-wrapper {
      gap: 1.5rem;
    }

    .cert-content {
      max-width: 100%;
      padding: 0;
      /* Ensure text is readable on mobile */
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      -webkit-hyphens: auto;
      -ms-hyphens: auto;
    }

    /* Force all text to wrap on mobile */
    .cert-content * {
      max-width: 100%;
      box-sizing: border-box;
    }

    .cert-content p,
    .cert-content li,
    .cert-content td,
    .cert-content th {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
    }

    .cert-content h1 {
      font-size: 1.875rem;
      line-height: 1.3;
    }

    .cert-content h2 {
      font-size: 1.5rem;
      line-height: 1.4;
    }

    .cert-content h3 {
      font-size: 1.25rem;
      line-height: 1.4;
    }

    .cert-content p,
    .cert-content ul,
    .cert-content ol {
      font-size: 0.95rem;
      line-height: 1.7;
    }

    .cert-content pre {
      font-size: 0.875rem;
      padding: 0.875rem;
      overflow-x: auto;
    }

    .cert-content img {
      max-width: 100%;
      height: auto;
    }

    .cert-content table {
      display: block;
      overflow-x: auto;
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .cert-page-wrapper {
      padding: 0.75rem;
    }

    .cert-content h1 {
      font-size: 1.625rem;
    }

    .cert-content h2 {
      font-size: 1.375rem;
    }

    .cert-content h3 {
      font-size: 1.125rem;
    }

    .cert-content p,
    .cert-content ul,
    .cert-content ol {
      font-size: 0.9rem;
      line-height: 1.65;
    }
  }

  .breadcrumbs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
    margin-top: 0;
    padding-top: 4.5rem; /* Space for fixed buttons at top */
    font-family: 'Poppins', sans-serif;
    font-size: 0.9rem;
    flex-wrap: wrap;
  }

  @media (max-width: 768px) {
    .breadcrumbs {
      padding-top: 3.5rem; /* Less space on mobile */
    }
  }

  @media (max-width: 480px) {
    .breadcrumbs {
      padding-top: 3rem; /* Even less on very small screens */
    }
  }

  .breadcrumbs a {
    color: var(--accent-color, #d4b78c);
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .breadcrumbs a:hover {
    opacity: 0.8;
  }

  .breadcrumb-separator {
    color: var(--text-muted, #999);
  }

  .breadcrumb-current {
    color: var(--fg-color, #e6e0d6);
    font-weight: 600;
  }

  .cert-meta {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color, #222);
  }

  .cert-stats {
    color: var(--text-muted, #ccc);
    font-family: 'Poppins', sans-serif;
    font-size: 0.85rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .cert-taxonomy {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .category-tag,
  .vendor-tag,
  .cert-tag {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.85rem;
    font-family: 'Poppins', sans-serif;
    transition: all 0.2s ease;
    text-transform: capitalize;
  }

  .category-tag {
    background: rgba(212, 183, 140, 0.2);
    color: var(--accent-color, #d4b78c);
    border: 1px solid var(--accent-color, #d4b78c);
  }

  .category-tag:hover {
    background: var(--accent-color, #d4b78c);
    color: var(--bg-color, #0b0b0b);
  }

  .vendor-tag,
  .cert-tag {
    background: rgba(255, 255, 255, 0.05);
    color: var(--fg-color, #e6e0d6);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .vendor-tag:hover,
  .cert-tag:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--accent-color, #d4b78c);
  }

  .cert-content {
    text-align: left;
    line-height: 1.8;
    /* Chirpy-style: Optimal reading width */
    max-width: 65ch;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    /* Ensure proper text wrapping */
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
  }

  /* Ensure content doesn't exceed container on desktop */
  @media (min-width: 769px) {
    .cert-content {
      max-width: min(65ch, 100%);
    }
  }

  /* Force wrapping for all text elements */
  .cert-content p,
  .cert-content li,
  .cert-content td,
  .cert-content th,
  .cert-content span:not(pre span):not(code span),
  .cert-content div:not(pre):not(.code-block-wrapper) {
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
  }

  /* Headings should also wrap */
  .cert-content h1,
  .cert-content h2,
  .cert-content h3,
  .cert-content h4,
  .cert-content h5,
  .cert-content h6 {
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
  }

  .cert-content h1,
  .cert-content h2,
  .cert-content h3 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-family: 'Poppins', sans-serif;
  }

  .cert-content h1 {
    font-size: 2.5rem;
    border-bottom: 2px solid var(--border-color, #222);
    padding-bottom: 0.5rem;
  }

  .cert-content h2 {
    font-size: 2rem;
    color: var(--accent-color, #d4b78c);
  }

  .cert-content h3 {
    font-size: 1.5rem;
  }

  .cert-content p,
  .cert-content ul,
  .cert-content ol {
    font-size: 1rem;
    line-height: 1.75;
    margin: 1.25em 0;
  }

  .cert-content code {
    background: rgba(212, 183, 140, 0.1);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-size: 0.95em;
  }

  .cert-content pre {
    background: #ccc7b2;
    border: 1px solid rgba(204, 199, 178, 0.3);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: visible;
    overflow-wrap: break-word;
    word-wrap: break-word;
    white-space: pre-wrap;
    position: relative;
    margin: 1.2em 0;
  }

  .cert-content pre code {
    background: transparent;
    padding: 0;
    color: #0b0b0b;
    font-size: 0.95em;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
  }

  @media (max-width: 1200px) {
    .cert-content-wrapper {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }

  @media (max-width: 768px) {
    .cert-page-wrapper {
      padding: 1rem;
    }

    .cert-content h1 {
      font-size: 2rem;
    }

    .cert-content-wrapper {
      gap: 1.5rem;
    }
  }
</style>

<script>
  // Detect container width and ensure proper text wrapping
  (function() {
    function ensureTextWrapping() {
      const content = document.querySelector('.cert-content');
      if (!content) return;

      // Force wrapping on all text elements
      const textElements = content.querySelectorAll('p, li, td, th, span, div, h1, h2, h3, h4, h5, h6');
      textElements.forEach(el => {
        // Skip code blocks and pre elements
        if (el.closest('pre') || el.closest('code')) return;
        
        const computedStyle = window.getComputedStyle(el);
        const width = el.offsetWidth;
        const parentWidth = el.parentElement?.offsetWidth || 0;
        
        // If element is wider than parent, force wrapping
        if (width > parentWidth && parentWidth > 0) {
          el.style.maxWidth = '100%';
          el.style.wordWrap = 'break-word';
          el.style.overflowWrap = 'break-word';
          el.style.wordBreak = 'break-word';
        }
      });

      // Ensure content container doesn't exceed viewport
      const container = document.querySelector('.cert-page-wrapper');
      if (container) {
        const containerWidth = container.offsetWidth;
        const viewportWidth = window.innerWidth;
        
        if (containerWidth > viewportWidth) {
          container.style.maxWidth = '100%';
          container.style.overflowX = 'hidden';
        }
      }
    }

    // Run on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ensureTextWrapping);
    } else {
      ensureTextWrapping();
    }

    // Run on resize
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(ensureTextWrapping, 100);
    });

    // Run on Astro page transitions
    document.addEventListener('astro:page-load', ensureTextWrapping);

    // Use ResizeObserver for more accurate detection
    if (typeof ResizeObserver !== 'undefined') {
      const content = document.querySelector('.cert-content');
      if (content) {
        const observer = new ResizeObserver(() => {
          ensureTextWrapping();
        });
        observer.observe(content);
      }
    }
  })();
</script>
