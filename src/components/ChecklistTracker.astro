---
// Interactive Checklist Tracker Component
// Provides interactive checkboxes with localStorage persistence for methodologies with checklists

interface Props {
  methodologyId: string;
  content?: string;
}

const { methodologyId, content = '' } = Astro.props;

// Check if content has checklists (markdown checkboxes)
const hasChecklists = content.includes('- [ ]') || content.includes('- [x]');
---

{hasChecklists && (
  <div class="checklist-tracker" data-methodology-id={methodologyId}>
    <div class="checklist-header">
      <h3 class="checklist-title">Interactive Checklist</h3>
      <div class="checklist-actions">
        <button class="checklist-action-btn" id="checklist-reset" title="Reset all checkboxes">
          Reset
        </button>
        <button class="checklist-action-btn" id="checklist-export" title="Export checklist">
          Export
        </button>
      </div>
    </div>
    <div class="checklist-progress">
      <div class="checklist-progress-bar">
        <div class="checklist-progress-fill" id="checklist-progress-fill" style="width: 0%"></div>
      </div>
      <span class="checklist-progress-text" id="checklist-progress-text">0% Complete</span>
    </div>
    <div class="checklist-content" id="checklist-content">
      <!-- Content will be processed by JavaScript -->
    </div>
  </div>
)}

<style>
  .checklist-tracker {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--card-bg, rgba(255, 255, 255, 0.02));
    border: 1px solid var(--border-color, #222);
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
  }

  .checklist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .checklist-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: var(--accent-color, #d4b78c);
  }

  .checklist-actions {
    display: flex;
    gap: 0.5rem;
  }

  .checklist-action-btn {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color, #222);
    border-radius: 6px;
    color: var(--fg-color, #e6e0d6);
    font-size: 0.85rem;
    font-family: 'Poppins', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }

  .checklist-action-btn:hover {
    background: rgba(212, 183, 140, 0.1);
    border-color: var(--accent-color, #d4b78c);
    color: var(--accent-color, #d4b78c);
  }

  .checklist-progress {
    margin-bottom: 1.5rem;
  }

  .checklist-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .checklist-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-color, #d4b78c), rgba(212, 183, 140, 0.7));
    border-radius: 4px;
    transition: width 0.3s ease;
  }

  .checklist-progress-text {
    font-size: 0.85rem;
    color: var(--text-muted, #999);
  }

  .checklist-content {
    line-height: 1.8;
  }

  .checklist-content :global(input[type="checkbox"]) {
    width: 18px;
    height: 18px;
    margin-right: 0.5rem;
    cursor: pointer;
    accent-color: var(--accent-color, #d4b78c);
  }

  .checklist-content :global(li) {
    margin: 0.5rem 0;
    padding-left: 0.5rem;
  }

  .checklist-content :global(li:has(input:checked)) {
    opacity: 0.6;
    text-decoration: line-through;
  }
</style>

<script>
  (function() {
    const checklistTracker = document.querySelector('.checklist-tracker');
    if (!checklistTracker) return;

    const methodologyId = checklistTracker.getAttribute('data-methodology-id');
    if (!methodologyId) return;

    const storageKey = `checklist-${methodologyId}`;
    const contentArea = document.querySelector('.methodology-content');
    if (!contentArea) return;

    // Find all checkboxes in the content
    function findCheckboxes() {
      return contentArea.querySelectorAll('input[type="checkbox"]');
    }

    // Load saved state from localStorage
    function loadChecklistState() {
      const saved = localStorage.getItem(storageKey);
      if (!saved) return {};

      try {
        return JSON.parse(saved);
      } catch (e) {
        return {};
      }
    }

    // Save state to localStorage
    function saveChecklistState(state: Record<string, boolean>) {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    // Update progress
    function updateProgress() {
      const checkboxes = findCheckboxes();
      if (checkboxes.length === 0) return;

      const checked = Array.from(checkboxes).filter((cb: HTMLInputElement) => cb.checked).length;
      const total = checkboxes.length;
      const percentage = Math.round((checked / total) * 100);

      const progressFill = document.getElementById('checklist-progress-fill');
      const progressText = document.getElementById('checklist-progress-text');

      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
      }
      if (progressText) {
        progressText.textContent = `${percentage}% Complete (${checked}/${total})`;
      }
    }

    // Initialize checkboxes
    function initializeCheckboxes() {
      const checkboxes = findCheckboxes();
      const state = loadChecklistState();

      checkboxes.forEach((checkbox: HTMLInputElement) => {
        // Generate unique ID for checkbox
        const listItem = checkbox.closest('li');
        if (!listItem) return;

        const text = listItem.textContent?.trim() || '';
        const checkboxId = `${methodologyId}-${text.substring(0, 50)}`;

        // Restore state
        if (state[checkboxId] !== undefined) {
          checkbox.checked = state[checkboxId];
        }

        // Add event listener
        checkbox.addEventListener('change', () => {
          state[checkboxId] = checkbox.checked;
          saveChecklistState(state);
          updateProgress();
        });
      });

      updateProgress();
    }

    // Reset all checkboxes
    function resetCheckboxes() {
      if (!confirm('Reset all checkboxes? This cannot be undone.')) return;

      const checkboxes = findCheckboxes();
      checkboxes.forEach((checkbox: HTMLInputElement) => {
        checkbox.checked = false;
      });

      localStorage.removeItem(storageKey);
      updateProgress();
    }

    // Export checklist
    function exportChecklist() {
      const checkboxes = findCheckboxes();
      const items: Array<{ text: string; checked: boolean }> = [];

      checkboxes.forEach((checkbox: HTMLInputElement) => {
        const listItem = checkbox.closest('li');
        if (listItem) {
          items.push({
            text: listItem.textContent?.trim() || '',
            checked: checkbox.checked
          });
        }
      });

      const markdown = items.map(item => 
        `- [${item.checked ? 'x' : ' '}] ${item.text.replace(/^\[[x ]\]\s*/, '')}`
      ).join('\n');

      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${methodologyId}-checklist.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializeCheckboxes, 100);
      });
    } else {
      setTimeout(initializeCheckboxes, 100);
    }

    // Handle Astro page transitions
    document.addEventListener('astro:page-load', () => {
      setTimeout(initializeCheckboxes, 100);
    });

    // Event listeners for action buttons
    const resetBtn = document.getElementById('checklist-reset');
    const exportBtn = document.getElementById('checklist-export');

    if (resetBtn) {
      resetBtn.addEventListener('click', resetCheckboxes);
    }
    if (exportBtn) {
      exportBtn.addEventListener('click', exportChecklist);
    }
  })();
</script>

